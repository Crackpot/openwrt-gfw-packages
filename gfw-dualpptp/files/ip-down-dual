
PPP_IFACE="$1";
PPP_TTY="$2";
PPP_SPEED="$3";
PPP_LOCAL="$4";
PPP_REMOTE="$5";
PPP_IPPARAM="$6";

. /lib/functions.sh

local enabled
local interface
local mtu
local mainiface
local mainaddress

config_load gfw-dualpptp
config_get_bool enabled general enabled
config_get interface general secondaryvpnifname
config_get mtu general secondaryvpnmtu
config_get mainiface general mainvpnifname
config_load network
config_get mainaddress $mainiface server
interface=$(uci_get_state network "$interface" ifname "$interface")

ip_down_cdual() {
        iptables -D INPUT -p 47 -i $PPP_IFACE -j ACCEPT
        iptables -D INPUT -p tcp --sport 1723 -i $PPP_IFACE -j ACCEPT
        iptables -D INPUT -p tcp --dport 1723 -i $PPP_IFACE -j ACCEPT
        iptables -D FORWARD -p 47 -o $PPP_IFACE -j ACCEPT
        iptables -D FORWARD -p tcp --sport 1723 -o $PPP_IFACE -j ACCEPT
        iptables -D FORWARD -p tcp --dport 1723 -o $PPP_IFACE -j ACCEPT

        iptables -t mangle -D OUTPUT -p 47 -d $mainaddress -m u32 --u32 "0>>22&0x3C@4>>16=0x1:0xFFFF" -j dupgre
        iptables -t mangle -F dupgre
        iptables -t mangle -X dupgre

        iptables -t mangle -D OUTPUT -p tcp --sport 1723 -d $mainaddress -j duptcp
        iptables -t mangle -D OUTPUT -p tcp --dport 1723 -d $mainaddress -j duptcp
        iptables -t mangle -F duptcp
        iptables -t mangle -X duptcp
}

if [ "$PPP_IFACE" == "$interface" -a $enabled -eq 1 ]; then
        ip_down_cdual
fi

